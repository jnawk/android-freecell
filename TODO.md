# TODO List for Android Freecell

## Game Logic
- [x] Implement win condition check in `FreecellGameEngine.kt` (Issue #4)
  - Check if all foundation piles are complete (King on top for each suit)
- [x] Fix bug with card movements from free cells to tableau (Issue #3)
  - Queens in free cells cannot be moved to legal King positions in tableau
  - Jacks in free cells cannot be moved to legal Queen positions in tableau
- [x] Refactor: Use sealed classes instead of marker interfaces for animation types (Issue #19)
  - Replace marker interfaces (Source, Destination) with sealed classes
  - Provide more type safety and make relationships between types more explicit
- [ ] Refactor: Organize animation classes into subpackages (Issue #20)
  - Organize related animation classes into subpackages
  - Avoid name conflicts and improve code organization
- [ ] Implement supermoves (Issue #6)
  - Detect when multiple cards form a valid sequence (alternating colors, descending ranks)
  - Allow dragging the entire sequence as one unit
  - Validate that the destination can accept the sequence (enough free cells available)
  - Implement the "Freecell power move" formula: (# empty freecells + 1) Ã— 2^(# empty columns)
  - Each card in a supermove counts as a separate move for the move counter
  - Each card in a supermove is recorded separately in the undo stack
  - Supermoves should move as many cards as possible within the constraints
  - Highlight valid destinations that involve supermoves
  - When highlighting a supermove destination, highlight the target card
  - Animate cards moving during supermoves (to free cells, empty tableau, and back)
  - Keep animations quick to maintain good gameplay experience
  - Undoing a move counts as a move for the move counter
  - Implementation plan:
    - Add methods to detect valid card sequences in tableau piles
    - Implement the power move formula to calculate max movable cards
    - Extend move validation to check for supermove possibilities
    - Update the UI to highlight supermove destinations
    - Implement the card movement logic with proper animation
    - Record each card movement separately for undo and move counting

- [ ] Animate supermoves (Issue #16)
  - Add animations for cards moving during supermoves
  - Show each card moving individually to maintain visual clarity
  - Ensure animations are quick enough to maintain good gameplay experience
  - Animate cards moving to free cells and back during complex supermoves

- [ ] Fix supermove card selection (Issue #17)
  - Allow selecting the bottom card of a sequence to initiate a supermove
  - When selecting the bottom card, move the entire valid sequence above it
  - Maintain the ability to select cards in the middle of a sequence for more granular moves

- [x] Fix supermove undo functionality (Issue #18)
  - Ensure cards are returned to their original positions in the correct order
  - Fix the issue where cards are swapped or placed incorrectly during undo
  - Ensure the undo animation matches the original move animation
  - Maintain the proper sequence of cards after multiple undo operations
- [x] Implement move counter (Issue #7)
  - Increment counter for each valid move
  - Display the counter in the UI
  - Reset counter when starting a new game
- [x] Implement undo stack (Issue #8)
  - Store each move in an undo stack with unlimited history
  - Implementation plan:
    - Add a Move data class to store move type, source, destination, and card
    - Add an undo stack to FreecellGameEngine (Stack<Move>)
    - Record each move in the stack when it's made
    - Implement an undo method that pops the last move and reverses it
    - Add a UI button to trigger the undo action
  - Memory usage is minimal (approximately 32-36 bytes per move)
  - Even 500 moves would only use about 16-18 KB of memory
- [ ] Detect when a game is "stuck" (Issue #10)
  - Analyze the current game state to determine if any valid moves remain
  - Notify the player when they are stuck
  - Offer options (restart, new game, undo)
- [x] Animate undo operations (Issue #15)
  - Add smooth animations when undoing moves
  - Cards should visually move back to their original positions
  - Ensure animations are fast enough not to slow down gameplay

## UI Improvements
- [x] Fix clipping of cards at the bottom of tall tableau piles (Issue #1)
  - Implemented solution: Initially size the view to accommodate the maximum possible pile height (19 cards)
- [x] Fix issue with cards not being revealed properly when dragging (Issue #2)
  - When a card is dragged away, the card underneath is not revealed until the card is released
- [x] Add "New Game" button (Issue #9)
  - Add a "New Game" button to the UI
  - Implement functionality to reset the game state and deal a new hand
  - Confirm with the player before abandoning the current game
- [ ] Preserve game state during screen rotation (Issue #11)
  - Save game state before rotation
  - Restore game state after rotation
  - Prevent new game from being dealt on rotation
- [ ] Improve win dialog button labels (Issue #12)
  - Change "Deal Again" and "Close" buttons to "Yes" and "No" 
  - Make them directly answer the question "Deal again?"
- [ ] Skip confirmation for "New Game" when game is already won (Issue #13)
  - When the game is won and the user opted not to deal again
  - Clicking "New Game" should start a new game immediately without confirmation
- [ ] Add victory animation (Issue #14)
  - When the game is won, animate all cards flying away in random directions
  - Add downward bias since cards are at the top of the screen
  - Animation should last no more than 2 seconds

## Configuration
- [ ] Configure data backup rules in `data_extraction_rules.xml` (Issue #5)
  - Use `<include>` and `<exclude>` to control what is backed up
